name: 'Check compliance of tfplan with OPA'
 
on:
  workflow_call:
  #  branches:
   # - main
  pull_request:
env:
  OPA_VERSION: v0.49.0
  TF_FILE_PATH: tfplan.json
  REGO_PATH: OPA/Rules/CountVMName.rego
  OUTPUT_PATH: result.json
 
jobs:
  OPA:
    name: 'Install OPA'
    runs-on: ubuntu-latest

    steps:
    - name: "[+] Checkout code"
      uses: actions/checkout@v2

    - name: "[+] Install OPA"
      run: |
        sudo apt-get update
        sudo apt-get install wget jq -y
        wget https://github.com/open-policy-agent/opa/releases/download/$OPA_VERSION/opa_linux_amd64
        sudo mv opa_linux_amd64 /usr/local/bin/opa
        sudo chmod 755 /usr/local/bin/opa

    - name: Download a single artifact
      uses: actions/download-artifact@v3
      with:
        name: tfplan.json

    - name: "[+] Check VM name with OPA rules"
      run: |
        opa eval -i $TF_FILE_PATH -d $REGO_PATH "data.main.deny" -f pretty > $OUTPUT_PATH
        ls
        ls $OUTPUT_PATH
        cat $OUTPUT_PATH
    - name: "[+] Show result.json"
      run: cat $OUTPUT_PATH
    - name: "[+] Exit 1 if error "
      run: |
        #[+] Exit 1 if error
        if  [[ -z $(cat $OUTPUT_PATH | jq '.[]') ]]; then
            exit 0
        else
            exit 1
        fi